<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trustpilot Review Bot</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... (keep existing styles) ... */
    </style>
</head>
<body>
    <!-- ... (keep existing sections) ... -->

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p class="loading-text">Loading...</p>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyAxtDaiDZdNA8Zl9OgNVbkYEDdKywo3F4Q",
          authDomain: "pointgram-e1dbd.firebaseapp.com",
          databaseURL: "https://pointgram-e1dbd-default-rtdb.firebaseio.com",
          projectId: "pointgram-e1dbd",
          storageBucket: "pointgram-e1dbd.firebasestorage.app",
          messagingSenderId: "1029432630709",
          appId: "1:1029432630709:web:4eba3be318dd3059674dfc"
        };

        // Check if Firebase is already initialized
        let app;
        if (firebase.apps.length === 0) {
          app = firebase.initializeApp(firebaseConfig);
        } else {
          app = firebase.app();
        }
        const db = firebase.firestore();

        // Global variables
        let tg = null;
        let telegramUser = null;
        let referralCode = null;
        let referralCount = 0;
        let referralEarnings = 0;
        let reviewCount = null;
        let userLevel = null;
        let selectedCountry = "";
        let trustpilotLink = "";
        let currentSection = null;

        // Initialize Telegram Web App
        function initTelegram() {
          try {
            if (window.Telegram && window.Telegram.WebApp) {
              tg = window.Telegram.WebApp;
              tg.ready();
              telegramUser = tg.initDataUnsafe.user;
              
              if (telegramUser) {
                localStorage.setItem('telegramUserId', telegramUser.id);
                localStorage.setItem('telegramUsername', telegramUser.username);
                localStorage.setItem('telegramFirstName', telegramUser.first_name);
                return true;
              }
            }
            return false;
          } catch (error) {
            console.error('Telegram initialization error:', error);
            return false;
          }
        }

        // Show loading overlay
        function showLoading(message = "Loading...") {
          const overlay = document.getElementById('loadingOverlay');
          const text = overlay.querySelector('.loading-text');
          text.textContent = message;
          overlay.style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
          document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Show notification
        function showNotification(message, type = 'success') {
          const notification = document.getElementById('notification');
          notification.textContent = message;
          notification.className = 'notification show';
          if (type === 'error') {
            notification.classList.add('error');
          } else if (type === 'warning') {
            notification.classList.add('warning');
          }
          setTimeout(() => {
            notification.classList.remove('show');
          }, 3000);
        }

        // Show error message
        function showError(message) {
          const errorBox = document.getElementById('section-error');
          const errorMessage = document.getElementById('error-message');
          errorMessage.textContent = message;
          errorBox.classList.add('visible');
          setTimeout(() => errorBox.classList.remove('visible'), 5000);
        }

        // Validate Trustpilot link
        function validateTrustpilotLink() {
          const linkInput = document.getElementById('trustpilot-link');
          const linkHint = document.getElementById('link-hint');
          const trustpilotRegex = /^https:\/\/(?:[a-z]{2}|www)\.trustpilot\.com\/users\/.+$/;
          
          if (!linkInput.value) {
            linkInput.classList.remove('valid', 'invalid');
            linkHint.classList.remove('error');
            linkHint.textContent = 'Enter your Trustpilot profile link';
          } else if (trustpilotRegex.test(linkInput.value)) {
            linkInput.classList.add('valid');
            linkInput.classList.remove('invalid');
            linkHint.classList.remove('error');
            linkHint.textContent = 'Valid profile link';
          } else {
            linkInput.classList.add('invalid');
            linkInput.classList.remove('valid');
            linkHint.classList.add('error');
            linkHint.textContent = 'Invalid format. Example: https://www.trustpilot.com/users/username';
          }
          validateForm();
        }

        // Validate form
        function validateForm() {
          const linkInput = document.getElementById('trustpilot-link');
          const trustpilotRegex = /^https:\/\/(?:[a-z]{2}|www)\.trustpilot\.com\/users\/.+$/;
          const continueButton = document.getElementById('fixedButton');
          
          if (continueButton) {
            continueButton.disabled = !(linkInput.value && trustpilotRegex.test(linkInput.value) && reviewCount !== null);
          }
        }

        // Select review count
        function selectReviewCount(count) {
          reviewCount = count;
          userLevel = determineUserLevel(reviewCount);
          
          document.querySelectorAll('.answer-button').forEach(btn => btn.classList.remove('selected'));
          event.target.classList.add('selected');
          
          validateForm();
        }

        // Generate random country
        function selectRandomCountry() {
          return countries[Math.floor(Math.random() * countries.length)];
        }

        // Determine user level
        function determineUserLevel(count) {
          if (count >= 30) return 4;
          if (count >= 20) return 3;
          if (count >= 10) return 2;
          return 1;
        }

        // Get level details
        function getLevelDetails(level) {
          return {
            1: { min: 0, max: 9,   pay: 0.10, perDay: 1 },
            2: { min: 10, max: 19, pay: 0.15, perDay: 1 },
            3: { min: 20, max: 29, pay: 0.20, perDay: 4 },
            4: { min: 30, max: Infinity, pay: 0.35, perDay: 5 }
          }[level];
        }

        // Generate referral code
        function generateReferralCode() {
          const prefix = "TRUST";
          const random = Math.floor(1000 + Math.random() * 9000);
          return prefix + random;
        }

        // Copy referral code
        function copyReferralCode() {
          if (!referralCode) return;
          
          navigator.clipboard.writeText(referralCode).then(() => {
            showNotification("Referral code copied to clipboard!");
          }).catch(err => {
            console.error('Failed to copy: ', err);
            showNotification("Failed to copy code", "error");
          });
        }

        // Share referral link
        function shareReferralLink() {
          if (!referralCode) return;
          
          const referralLink = `https://t.me/YourBotUsername?start=${referralCode}`;
          const shareText = `Join Trustpilot Review Bot and earn money! Use my referral code: ${referralCode}`;
          
          if (tg && tg.share) {
            tg.shareText(shareText);
          } else if (navigator.share) {
            navigator.share({
              title: 'Trustpilot Review Bot',
              text: shareText,
              url: referralLink
            });
          } else {
            // Fallback
            const tempInput = document.createElement('input');
            tempInput.value = referralLink;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            showNotification("Referral link copied to clipboard!");
          }
        }

        // Close referral modal
        function closeReferralModal() {
          document.getElementById('referralModal').classList.remove('active');
        }

        // Show referral modal
        function showReferralModal() {
          if (!referralCode) {
            referralCode = generateReferralCode();
            document.getElementById('referralCode').textContent = referralCode;
          }
          
          document.getElementById('referralCount').textContent = referralCount;
          document.getElementById('referralEarningsStat').textContent = `$${referralEarnings.toFixed(2)}`;
          
          document.getElementById('referralModal').classList.add('active');
        }

        // Update earnings display
        function updateEarningsDisplay() {
          const reviewEarnings = (reviewCount || 0) * getLevelDetails(userLevel || 1).pay;
          const totalEarnings = reviewEarnings + referralEarnings;
          
          const reviewElems = document.getElementById('reviewEarnings');
          const referralElems = document.getElementById('referralEarnings');
          const totalElems = document.getElementById('totalEarnings');
          
          if (reviewElems) reviewElems.textContent = `$${reviewEarnings.toFixed(2)}`;
          if (referralElems) referralElems.textContent = `$${referralEarnings.toFixed(2)}`;
          if (totalElems) totalElems.textContent = `$${totalEarnings.toFixed(2)}`;
        }

        // Process referral
        function processReferral(referralCodeParam) {
          if (!referralCodeParam) return;
          
          try {
            const referrerRef = db.collection('users').doc(referralCodeParam);
            referrerRef.get().then(doc => {
              if (doc.exists) {
                referrerRef.update({
                  referralEarnings: firebase.firestore.FieldValue.increment(0.50),
                  referralCount: firebase.firestore.FieldValue.increment(1)
                });
                
                const userId = localStorage.getItem('userId');
                if (userId) {
                  const userRef = db.collection('users').doc(userId);
                  userRef.update({
                    refereeEarnings: 0.10
                  });
                }
                
                showNotification("Referral processed successfully!");
              }
            });
          } catch (error) {
            console.error('Error processing referral:', error);
            showNotification("Error processing referral", "error");
          }
        }

        // Show section
        function showSection(sectionId) {
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          const section = document.getElementById(sectionId);
          if (section) {
            section.classList.add('active');
            currentSection = sectionId;
            updateFixedButton();
          }
        }

        // Show level system
        function showLevelSystem() {
          showSection('level-section');
        }

        // Show question section
        function showQuestion() {
          showSection('question-section');
        }

        // Continue to country section
        function continueToCountry() {
          trustpilotLink = document.getElementById('trustpilot-link').value;
          const trustpilotRegex = /^https:\/\/(?:[a-z]{2}|www)\.trustpilot\.com\/users\/.+$/;
          
          if (!trustpilotLink || !trustpilotRegex.test(trustpilotLink)) {
            showError('Please enter a valid Trustpilot profile link');
            return;
          }
          
          if (reviewCount === null) {
            showError('Please select your review count');
            return;
          }
          
          selectedCountry = selectRandomCountry();
          document.getElementById('selectedCountry').textContent = selectedCountry;
          document.getElementById('countryNameInText').textContent = selectedCountry;
          
          showSection('country-section');
        }

        // Submit application
        async function submitApplication() {
          try {
            showLoading("Submitting your application...");
            
            // Initialize Telegram if not done
            if (!initTelegram()) {
              showError('Please open this app in Telegram to continue');
              hideLoading();
              return;
            }
            
            const userId = trustpilotLink.split('/users/')[1];
            const userRef = db.collection('users').doc(userId);
            const telegramUserId = localStorage.getItem('telegramUserId');
            const telegramUsername = localStorage.getItem('telegramUsername');
            const telegramFirstName = localStorage.getItem('telegramFirstName');
            
            let fullName = '';
            if (telegramUser) {
              fullName = telegramUser.first_name + (telegramUser.last_name ? ' ' + telegramUser.last_name : '');
            }
            
            // Check for referral code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const referralParam = urlParams.get('ref');
            
            const doc = await userRef.get();
            await userRef.set({
              trustpilotLink,
              reviewCount,
              userLevel,
              selectedCountry,
              approved: doc.exists ? doc.data().approved : false,
              deleted: doc.exists ? doc.data().deleted : false,
              telegramUserId,
              telegramUsername,
              telegramFirstName,
              fullName,
              referralCode: referralCode || generateReferralCode(),
              referralCount: 0,
              referralEarnings: 0,
              refereeEarnings: 0,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Process referral if exists
            if (referralParam) {
              processReferral(referralParam);
            }
            
            // Save to localStorage
            localStorage.setItem('userId', userId);
            localStorage.setItem('reviewCount', reviewCount);
            localStorage.setItem('userLevel', userLevel);
            localStorage.setItem('trustpilotLink', trustpilotLink);
            localStorage.setItem('selectedCountry', selectedCountry);
            localStorage.setItem('referralCode', referralCode || generateReferralCode());
            
            hideLoading();
            showSection('review-section');
            document.getElementById('approval-status').textContent = 'Pending Review';
            document.getElementById('approval-status').style.color = '#6c757d';
            document.getElementById('rejected-message').style.display = 'none';
            
            setupApprovalListener();
          } catch (error) {
            console.error('Error saving user data:', error);
            hideLoading();
            showError('Error saving your data. Please try again.');
          }
        }

        // Setup approval listener
        function setupApprovalListener() {
          const userId = localStorage.getItem('userId');
          if (!userId) return;
          
          const userRef = db.collection('users').doc(userId);
          
          // Set up real-time listener
          userRef.onSnapshot(doc => {
            if (doc.exists) {
              const data = doc.data();
              
              if (data.deleted) {
                showSection('review-section');
                document.getElementById('approval-status').textContent = 'Application Rejected';
                document.getElementById('approval-status').style.color = '#dc3545';
                document.getElementById('rejected-message').style.display = 'block';
              } else if (data.approved) {
                showSection('tasks-section');
                updateUserInfo();
                generateTaskCards();
                updateUserEarnings();
              } else {
                showSection('review-section');
                document.getElementById('approval-status').textContent = 'Pending Review';
                document.getElementById('approval-status').style.color = '#6c757d';
                document.getElementById('rejected-message').style.display = 'none';
              }
            }
          }, err => {
            console.error('Listener error:', err);
            showError('Error checking approval status.');
          });
        }

        // Update user info
        function updateUserInfo() {
          if (telegramUser) {
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userLevelText = document.getElementById('userLevelText');
            const levelBadge = document.getElementById('levelBadgeCorner');
            const levelUpButton = document.getElementById('levelUpButton');
            
            if (userInfo) userInfo.style.display = 'flex';
            
            if (userAvatar) {
              if (telegramUser.photo_url) {
                userAvatar.src = telegramUser.photo_url;
              } else {
                const name = telegramUser.first_name;
                userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0088cc&color=fff&size=60`;
              }
            }
            
            if (userName) {
              const fullName = telegramUser.first_name + (telegramUser.last_name ? ' ' + telegramUser.last_name : '');
              userName.textContent = fullName;
            }
            
            if (userLevelText) userLevelText.textContent = `Level ${userLevel || 1}`;
            if (levelBadge) {
              levelBadge.textContent = userLevel || 1;
              levelBadge.style.backgroundColor = 
                (userLevel === 1) ? '#0d47a1' :
                (userLevel === 2) ? '#2e7d32' :
                (userLevel === 3) ? '#ff8f00' :
                '#c62828';
            }
            
            if (levelUpButton) {
              levelUpButton.textContent = 'View Level System';
              levelUpButton.onclick = showLevelSystemForApprovedUser;
            }
          }
        }

        // Show level system for approved user
        function showLevelSystemForApprovedUser() {
          showSection('level-system-section');
        }

        // Generate task cards
        function generateTaskCards() {
          const container = document.getElementById('taskCards');
          if (!container) return;
          
          container.innerHTML = '';
          const tasksToShow = userLevel >= 4 ? 5 : (userLevel >= 3 ? 4 : 1);
          const levelDetails = getLevelDetails(userLevel);
          
          for (let i = 0; i < tasksToShow && i < tasks.length; i++) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.innerHTML = `
              <h3 class="task-title">${tasks[i].title}</h3>
              <p class="task-description">
                âœ… Give a 5-star Trustpilot review<br>
                ğŸ’° Instant payment via Binance<br>
                ğŸ’µ $${levelDetails.pay.toFixed(2)} per review<br>
                ğŸ“… ${levelDetails.perDay} reviews per day
              </p>
              <a href="${tasks[i].trustpilotUrl}" target="_blank" class="write-review-btn" onclick="markTaskComplete()">âœï¸ Write Review</a>
            `;
            container.appendChild(card);
          }
          
          updateEarningsDisplay();
        }

        // Mark task complete
        function markTaskComplete() {
          reviewCount++;
          userLevel = determineUserLevel(reviewCount);
          updateReviewCount();
          updateUserInfo();
          generateTaskCards();
        }

        // Update review count
        async function updateReviewCount() {
          try {
            const userId = localStorage.getItem('userId');
            if (!userId) return;
            
            const userRef = db.collection('users').doc(userId);
            await userRef.update({
              reviewCount,
              userLevel,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            localStorage.setItem('reviewCount', reviewCount);
            localStorage.setItem('userLevel', userLevel);
          } catch (error) {
            console.error('Error updating review count:', error);
            showError('Error updating your review count.');
          }
        }

        // Submit to admin
        function submitToAdmin() {
          window.location.href = "https://t.me/sufyanthedev";
        }

        // Resubmit application
        async function resubmitApplication() {
          const userId = localStorage.getItem('userId');
          if (!userId) return;
          
          showLoading("Resetting your application...");
          
          try {
            const userRef = db.collection('users').doc(userId);
            await userRef.update({
              deleted: false,
              approved: false,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            localStorage.removeItem('userId');
            localStorage.removeItem('reviewCount');
            localStorage.removeItem('userLevel');
            localStorage.removeItem('trustpilotLink');
            localStorage.removeItem('selectedCountry');
            
            hideLoading();
            showSection('country-section');
            showNotification('Application reset successfully. Please resubmit.');
          } catch (error) {
            console.error('Error resubmitting application:', error);
            hideLoading();
            showError('Error resubmitting application. Please try again.');
          }
        }

        // Update user earnings
        function updateUserEarnings() {
          const userId = localStorage.getItem('userId');
          if (!userId) return;
          
          db.collection('users').doc(userId).get().then(doc => {
            if (doc.exists) {
              const data = doc.data();
              referralCount = data.referralCount || 0;
              referralEarnings = data.referralEarnings || 0;
              updateEarningsDisplay();
            }
          }).catch(err => {
            console.error('Error updating earnings:', err);
          });
        }

        // Restore user state
        async function restoreUserState() {
          try {
            const userId = localStorage.getItem('userId');
            if (!userId) return false;
            
            showLoading("Restoring your session...");
            
            const userRef = db.collection('users').doc(userId);
            const doc = await userRef.get();
            
            if (!doc.exists) {
              localStorage.clear();
              hideLoading();
              return false;
            }
            
            const data = doc.data();
            reviewCount = parseInt(localStorage.getItem('reviewCount'));
            userLevel = parseInt(localStorage.getItem('userLevel'));
            trustpilotLink = localStorage.getItem('trustpilotLink');
            selectedCountry = localStorage.getItem('selectedCountry');
            referralCode = localStorage.getItem('referralCode');
            referralCount = data.referralCount || 0;
            referralEarnings = data.referralEarnings || 0;
            
            if ([reviewCount, userLevel, trustpilotLink, selectedCountry].some(v => v === null || v === undefined)) {
              localStorage.clear();
              hideLoading();
              return false;
            }
            
            hideLoading();
            
            if (data.deleted) {
              showSection('review-section');
              document.getElementById('approval-status').textContent = 'Application Rejected';
              document.getElementById('approval-status').style.color = '#dc3545';
              document.getElementById('rejected-message').style.display = 'block';
              return true;
            }
            
            if (data.approved) {
              showSection('tasks-section');
              updateUserInfo();
              generateTaskCards();
              updateUserEarnings();
              return true;
            }
            
            showSection('review-section');
            setupApprovalListener();
            return true;
          } catch (error) {
            console.error('Restore error:', error);
            hideLoading();
            localStorage.clear();
            return false;
          }
        }

        // Update fixed button container
        function updateFixedButton() {
          const container = document.getElementById('fixedButtonContainer');
          const button = document.getElementById('fixedButton');
          const description = document.getElementById('fixedDescription');
          const supportButton = document.getElementById('fixedSupportButton');
          const referralButton = document.getElementById('referralButton');
          const earningsSection = document.getElementById('earningsSection');
          
          if (!container) return;
          
          container.classList.remove('visible');
          button.style.display = 'none';
          supportButton.style.display = 'none';
          if (referralButton) referralButton.style.display = 'none';
          if (earningsSection) earningsSection.style.display = 'none';
          
          if (!currentSection) return;
          
          switch(currentSection) {
            case 'welcome-section':
              if (button) {
                button.textContent = 'âœ… I Understand - Continue';
                button.onclick = showLevelSystem;
                button.style.display = 'block';
                container.classList.add('visible');
              }
              break;
            case 'level-section':
              if (button) {
                button.textContent = 'âœ… Continue';
                button.onclick = showQuestion;
                button.style.display = 'block';
                container.classList.add('visible');
              }
              break;
            case 'question-section':
              if (button) {
                button.textContent = 'Continue';
                button.onclick = continueToCountry;
                button.style.display = 'block';
                container.classList.add('visible');
              }
              break;
            case 'country-section':
              if (button) {
                button.textContent = 'Submit Application';
                button.onclick = submitApplication;
                button.style.display = 'block';
                container.classList.add('visible');
              }
              break;
            case 'review-section':
              const userId = localStorage.getItem('userId');
              if (userId) {
                db.collection('users').doc(userId).get().then(doc => {
                  if (doc.exists && doc.data().deleted) {
                    if (button) {
                      button.textContent = 'ğŸ”„ Resubmit Application';
                      button.onclick = resubmitApplication;
                      button.style.display = 'block';
                      if (description) description.textContent = 'Click to resubmit your application';
                      container.classList.add('visible');
                    }
                  } else {
                    if (button) {
                      button.textContent = 'ğŸ“¤ Send Profile Link to Admin';
                      button.onclick = () => window.open('https://t.me/sufyanthedev', '_blank');
                      button.style.display = 'block';
                      if (description) description.textContent = 'Send your profile link to admin to speed up approval';
                      container.classList.add('visible');
                    }
                  }
                }).catch(err => {
                  console.error('Error checking user status:', err);
                  if (button) {
                    button.textContent = 'ğŸ“¤ Send Profile Link to Admin';
                    button.onclick = () => window.open('https://t.me/sufyanthedev', '_blank');
                    button.style.display = 'block';
                    if (description) description.textContent = 'Send your profile link to admin to speed up approval';
                    container.classList.add('visible');
                  }
                });
              } else {
                if (button) {
                  button.textContent = 'ğŸ“¤ Send Profile Link to Admin';
                  button.onclick = () => window.open('https://t.me/sufyanthedev', '_blank');
                  button.style.display = 'block';
                  if (description) description.textContent = 'Send your profile link to admin to speed up approval';
                  container.classList.add('visible');
                }
              }
              break;
            case 'tasks-section':
              if (button) {
                button.textContent = 'ğŸ“¤ Submit to Admin';
                button.onclick = submitToAdmin;
                button.style.display = 'block';
                if (description) description.textContent = 'Only LIVE reviews will be accepted';
                container.classList.add('visible');
              }
              
              if (referralButton) {
                referralButton.style.display = 'block';
                referralButton.onclick = showReferralModal;
              }
              
              if (earningsSection) {
                earningsSection.style.display = 'block';
                updateEarningsDisplay();
              }
              break;
            case 'level-system-section':
              if (button) {
                button.textContent = 'Back to Tasks';
                button.onclick = () => {
                  showSection('tasks-section');
                  updateUserInfo();
                };
                button.style.display = 'block';
                container.classList.add('visible');
              }
              break;
          }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
          try {
            // Initialize Telegram
            const telegramOK = initTelegram();
            
            if (!telegramOK) {
              const messageBox = document.querySelector('.message-box');
              if (messageBox) {
                messageBox.innerHTML += '<br><br><strong style="color:#dc3545;">Error:</strong> Open this app in Telegram to continue.';
              }
            }
            
            // Restore user state
            const restored = await restoreUserState();
            
            if (!restored) {
              showSection('welcome-section');
            } else {
              updateUserEarnings();
            }
          } catch (error) {
            console.error('Initialization error:', error);
            showSection('welcome-section');
          }
        });

        // Handle touch events
        document.addEventListener('touchstart', () => {}, { passive: true });
    </script>
</body>
</html>
